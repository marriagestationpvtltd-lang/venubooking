<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Transition Test - Nepali Date Picker</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Nepali Date Picker CSS -->
    <link rel="stylesheet" href="css/nepali-date-picker.css">
    
    <style>
        body {
            padding: 50px;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-pass { background-color: #28a745; }
        .status-fail { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h2 class="mb-4">
            <i class="fas fa-clock text-primary"></i> 
            Midnight Transition Test - Nepali Date Picker
        </h2>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            <strong>Test Purpose:</strong> This page tests that the Nepali date changes correctly at Nepal midnight (00:00 UTC+5:45),
            which is 18:15 UTC. The date should update automatically without page refresh.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h5>Current Time (Live Update)</h5>
                <div class="time-display">
                    <strong>Your Browser:</strong><br>
                    <span id="browserTime">Loading...</span>
                </div>
                <div class="time-display">
                    <strong>UTC:</strong><br>
                    <span id="utcTime">Loading...</span>
                </div>
                <div class="time-display">
                    <strong>Nepal Time (UTC+5:45):</strong><br>
                    <span id="nepalTime">Loading...</span>
                </div>
            </div>
            
            <div class="col-md-6">
                <h5>Current Nepali Date</h5>
                <div class="time-display">
                    <strong>Today (AD):</strong><br>
                    <span id="todayAD">Loading...</span>
                </div>
                <div class="time-display">
                    <strong>Today (BS):</strong><br>
                    <span id="todayBS">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>Midnight Countdown</h5>
            <div class="time-display text-center">
                <div class="countdown" id="countdown">Calculating...</div>
                <small class="text-muted">Time until next Nepal midnight (00:00 UTC+5:45)</small>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>Test Status</h5>
            <table class="table table-sm table-bordered">
                <tbody>
                    <tr>
                        <td><span class="status-indicator" id="status1"></span> Library loaded</td>
                        <td id="statusText1">-</td>
                    </tr>
                    <tr>
                        <td><span class="status-indicator" id="status2"></span> Nepal timezone calculation</td>
                        <td id="statusText2">-</td>
                    </tr>
                    <tr>
                        <td><span class="status-indicator" id="status3"></span> Date conversion accuracy</td>
                        <td id="statusText3">-</td>
                    </tr>
                    <tr>
                        <td><span class="status-indicator" id="status4"></span> Auto-refresh working</td>
                        <td id="statusText4">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="mt-4 alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle"></i> How to Test Midnight Transition:</h6>
            <ol class="mb-0">
                <li>Note the current Nepal date and time shown above</li>
                <li>Leave this page open and check it at Nepal midnight (18:15 UTC)</li>
                <li>The date should automatically update without refresh</li>
                <li>The countdown timer will show time remaining until next midnight</li>
                <li>When countdown reaches zero, the Nepal date should increment by 1 day</li>
            </ol>
        </div>
        
        <div class="mt-4">
            <h5>Simulation Mode (For Testing)</h5>
            <p>Click below to simulate different times around midnight:</p>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" id="simBefore">23:59 Nepal Time</button>
                <button class="btn btn-sm btn-outline-primary" id="simMidnight">00:00 Nepal Time</button>
                <button class="btn btn-sm btn-outline-primary" id="simAfter">00:01 Nepal Time</button>
                <button class="btn btn-sm btn-outline-danger" id="simReset">Reset</button>
            </div>
            <div class="mt-2" id="simResult"></div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Nepali Date Picker -->
    <script src="js/nepali-date-picker.js"></script>
    
    <script>
        let simulatedTime = null;
        let updateCount = 0;
        
        function updateStatus(statusNum, pass, text) {
            const indicator = document.getElementById('status' + statusNum);
            const textElem = document.getElementById('statusText' + statusNum);
            
            indicator.className = 'status-indicator ' + (pass ? 'status-pass' : 'status-fail');
            textElem.textContent = text;
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
        }
        
        function updateDisplay() {
            const now = simulatedTime || new Date();
            
            // Browser time
            document.getElementById('browserTime').textContent = now.toLocaleString();
            
            // UTC time
            document.getElementById('utcTime').textContent = now.toISOString().replace('T', ' ').replace('Z', ' UTC');
            
            // Check library
            if (typeof window.nepaliDateUtils === 'undefined') {
                updateStatus(1, false, 'Library not loaded');
                return;
            }
            updateStatus(1, true, 'OK');
            
            // Nepal time
            const nepalNow = simulatedTime ? 
                new Date(simulatedTime.getTime() + (345 * 60 * 1000)) :
                window.nepaliDateUtils.getCurrentNepaliTime();
            document.getElementById('nepalTime').textContent = 
                nepalNow.toISOString().replace('T', ' ').replace('Z', ' (UTC+5:45)');
            
            updateStatus(2, true, 'UTC+5:45 = ' + formatTime(nepalNow));
            
            // Today in Nepal
            const todayInNepal = simulatedTime ?
                { year: nepalNow.getUTCFullYear(), month: nepalNow.getUTCMonth() + 1, day: nepalNow.getUTCDate() } :
                window.nepaliDateUtils.getTodayInNepal();
            const todayADStr = `${todayInNepal.year}-${String(todayInNepal.month).padStart(2,'0')}-${String(todayInNepal.day).padStart(2,'0')}`;
            document.getElementById('todayAD').textContent = todayADStr;
            
            // Convert to BS
            const todayBS = window.nepaliDateUtils.adToBS(todayInNepal.year, todayInNepal.month, todayInNepal.day);
            const todayBSStr = window.nepaliDateUtils.formatBSDate(todayBS.year, todayBS.month, todayBS.day);
            document.getElementById('todayBS').textContent = todayBSStr;
            
            updateStatus(3, true, todayBSStr);
            
            // Countdown to next Nepal midnight
            const nepalHour = nepalNow.getUTCHours();
            const nepalMinute = nepalNow.getUTCMinutes();
            const nepalSecond = nepalNow.getUTCSeconds();
            
            const secondsUntilMidnight = (24 * 3600) - (nepalHour * 3600 + nepalMinute * 60 + nepalSecond);
            const hoursLeft = Math.floor(secondsUntilMidnight / 3600);
            const minutesLeft = Math.floor((secondsUntilMidnight % 3600) / 60);
            const secondsLeft = secondsUntilMidnight % 60;
            
            document.getElementById('countdown').textContent = 
                `${String(hoursLeft).padStart(2,'0')}:${String(minutesLeft).padStart(2,'0')}:${String(secondsLeft).padStart(2,'0')}`;
            
            // Update count
            updateCount++;
            updateStatus(4, updateCount > 1, `Updated ${updateCount} times`);
        }
        
        // Simulation functions
        function simulateMidnight(offsetSeconds) {
            // Calculate Nepal midnight time
            const now = new Date();
            const nepalNow = new Date(now.getTime() + (345 * 60 * 1000));
            const nepalMidnight = new Date(Date.UTC(
                nepalNow.getUTCFullYear(),
                nepalNow.getUTCMonth(),
                nepalNow.getUTCDate(),
                0, 0, offsetSeconds
            ));
            // Convert back to UTC
            simulatedTime = new Date(nepalMidnight.getTime() - (345 * 60 * 1000));
            updateDisplay();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
            setInterval(() => {
                if (!simulatedTime) {
                    updateDisplay();
                }
            }, 1000);
            
            // Simulation buttons
            document.getElementById('simBefore').addEventListener('click', () => {
                simulateMidnight(-60); // 23:59
                document.getElementById('simResult').innerHTML = 
                    '<div class="alert alert-info mt-2">Simulating 23:59 Nepal Time (1 minute before midnight)</div>';
            });
            
            document.getElementById('simMidnight').addEventListener('click', () => {
                simulateMidnight(0); // 00:00
                document.getElementById('simResult').innerHTML = 
                    '<div class="alert alert-success mt-2">Simulating 00:00 Nepal Time (midnight - date should change)</div>';
            });
            
            document.getElementById('simAfter').addEventListener('click', () => {
                simulateMidnight(60); // 00:01
                document.getElementById('simResult').innerHTML = 
                    '<div class="alert alert-success mt-2">Simulating 00:01 Nepal Time (1 minute after midnight)</div>';
            });
            
            document.getElementById('simReset').addEventListener('click', () => {
                simulatedTime = null;
                updateDisplay();
                document.getElementById('simResult').innerHTML = 
                    '<div class="alert alert-secondary mt-2">Reset to real time</div>';
            });
        });
    </script>
</body>
</html>
